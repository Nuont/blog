<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Elasticsearch环境搭建, 岛">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Elasticsearch环境搭建 | 岛</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>



   <style>
    body{
       background-image: url(https://w.wallhaven.cc/full/rd/wallhaven-rdg5jw.png);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">岛</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-tractor" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-book-open" style="zoom: 0.6;"></i>
      
      <span>笔记</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/tags">
          
          <i class="fas fa-tags" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>标签</span>
        </a>
      </li>
      
      <li>
        <a href="/categories">
          
          <i class="fas fa-bookmark" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>分类</span>
        </a>
      </li>
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-archive" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>归档</span>
        </a>
      </li>
      
      <li>
        <a href="/contact">
          
          <i class="far fa-comments" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>留言板</span>
        </a>
      </li>
      
      <li>
        <a href="/BUG">
          
          <i class="fas fa-bug" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>BUG</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-mug-hot" style="zoom: 0.6;"></i>
      
      <span>娱乐</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>音乐</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>电影</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>书籍</span>
        </a>
      </li>
      
      <li>
        <a href="/galleries">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>相册</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-secret" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-coffee" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">岛</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tractor"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-book-open"></i>
			
			笔记
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/tags " style="margin-left:50px">
				  
				   <i class="fa fas fa-tags" style="position: absolute;left:28px" ></i>
			      
		          <span>标签</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories " style="margin-left:50px">
				  
				   <i class="fa fas fa-bookmark" style="position: absolute;left:28px" ></i>
			      
		          <span>分类</span>
                  </a>
                </li>
              
                <li>

                  <a href="/archives " style="margin-left:50px">
				  
				   <i class="fa fas fa-archive" style="position: absolute;left:28px" ></i>
			      
		          <span>归档</span>
                  </a>
                </li>
              
                <li>

                  <a href="/contact " style="margin-left:50px">
				  
				   <i class="fa far fa-comments" style="position: absolute;left:28px" ></i>
			      
		          <span>留言板</span>
                  </a>
                </li>
              
                <li>

                  <a href="/BUG " style="margin-left:50px">
				  
				   <i class="fa fas fa-bug" style="position: absolute;left:28px" ></i>
			      
		          <span>BUG</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-mug-hot"></i>
			
			娱乐
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/music " style="margin-left:50px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:28px" ></i>
			      
		          <span>音乐</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>电影</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:50px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:28px" ></i>
			      
		          <span>书籍</span>
                  </a>
                </li>
              
                <li>

                  <a href="/galleries " style="margin-left:50px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:28px" ></i>
			      
		          <span>相册</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-secret"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-coffee"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/positivefunction" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>L
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/positivefunction" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="L" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/14.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Elasticsearch环境搭建</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Es/">
                                <span class="chip bg-color">Es</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Elasticsearch/" class="post-category">
                                Elasticsearch
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-06-17
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-06-17
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    52 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="一、Elasticsearch环境搭建"><a href="#一、Elasticsearch环境搭建" class="headerlink" title="一、Elasticsearch环境搭建"></a>一、Elasticsearch环境搭建</h2><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>Elasticsearch是一个基于Lucene的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。Elasticsearch用于云计算中，能够达到实时搜索，稳定，可靠，快速，安装使用方便</p>
<hr>
<h1 id="相关资料"><a href="#相关资料" class="headerlink" title="相关资料"></a>相关资料</h1><ul>
<li>加速下载网址1:<a target="_blank" rel="noopener" href="https://www.newbe.pro/Mirrors/Mirrors-Elasticsearch/">https://www.newbe.pro/Mirrors/Mirrors-Elasticsearch/</a></li>
<li>加速下载网址2:<a target="_blank" rel="noopener" href="https://elasticsearch.cn/download/">https://elasticsearch.cn/download/</a></li>
<li>中文社区 :<a target="_blank" rel="noopener" href="https://elasticsearch.cn/">https://elasticsearch.cn/</a></li>
<li>Logstash中文指南:<a target="_blank" rel="noopener" href="https://www.wenjiangs.com/doc/a6xejcpgn">https://www.wenjiangs.com/doc/a6xejcpgn</a></li>
</ul>
<h1 id="1-源文件安装ES"><a href="#1-源文件安装ES" class="headerlink" title="1.源文件安装ES"></a>1.源文件安装ES</h1><ul>
<li>下载，解压</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">// 这里以7.8.0版本作为演示
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.8.0-linux-x86_64.tar.gz
tar -zxvf elasticsearch-7.8.0-linux-x86_64.tar.gz
rm -rf elasticsearch-7.8.0-linux-x86_64.tar.gz
mv elasticsearch-7.8.0/ /usr/local/elasticsearch


// 增加es用户来运行rs，root不能直接运行
useradd es
passwd es 
chown -R es elasticsearch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>修改vim elasticsearch.yml 配置</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">cluster.name: panco-es
node.name: node-1
network.host: 0.0.0.0
http.port: 9200
discovery.seed_hosts: ["127.0.0.1", "[::1]"]
cluster.initial_master_nodes: ["node-1"]
xpack.security.enabled: false
path.data: /usr/local/elasticsearch/data
path.logs: /usr/local/elasticsearch/logs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>修改linux系统配置</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">-- 1.设置文件最大进程/线程/内存数,末尾追加内容：

vim /etc/security/limits.conf
*               soft    nofile          65536
*               hard    nofile          65536
*               soft    nproc           4096
*               hard    nproc           4096

-- 2.修改sysctl.conf:vim /etc/sysctl.conf
//添加内容
vm.max_map_count=262144
// 执行下面命令生效：
sysctl -p<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>启动</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">-- elasticsearch目录下bin下
执行: ./elasticsearch

-- 开机自启动：
chmod  755  /etc/rc.d/rc.local
vim /etc/rc.d/rc.local
su - es -c "/usr/local/elasticsearch/bin/elasticsearch -d"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Elasticsearch-单台服务器启动多个节点-伪集群"><a href="#Elasticsearch-单台服务器启动多个节点-伪集群" class="headerlink" title="Elasticsearch 单台服务器启动多个节点(伪集群)"></a>Elasticsearch 单台服务器启动多个节点(伪集群)</h2><ul>
<li><p>1.拷贝elasticsearch文件: cp -R elasticsearch elasticsearch-node-2</p>
</li>
<li><p>2.修改elasticsearch.yml配置</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">cluster.name: ls-es
node.name: node-2     # 节点名称需要修改
network.host: 0.0.0.0
http.port: 9201      # 端口修改
discovery.seed_hosts: ["127.0.0.1", "[::1]"]
cluster.initial_master_nodes: ["node-1"]
xpack.security.enabled: false
path.data: /usr/local/elasticsearch/data
path.logs: /usr/local/elasticsearch/logs
node.max_local_storage_nodes: 2   // 单台服务器最大节点数量需要修改，默认为1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>3.要点</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">1：一个集群有N（N&gt;1）个节点组成
2：节点的本质就是一个ES的运行实例，也就是一个JAVA进程，一台机器上可以运行多个ES实例，但在生产环境最好一台机器运行一个，防止一台机器挂了N个节点一起都挂了
3：节点分成主节点、数据节点、节点还有其他角色，比如：路由、竞选主等。每个节点都可以知道整个集群的状态信息，默认都具有路由和竞选主的角色。
4：主节点的功能最为关键，创建索引、删除索引、维护集群状态信息、分片分配、路由等。
5：数据节点主要用于数据存储，路由<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="2-Docker-安装-ES"><a href="#2-Docker-安装-ES" class="headerlink" title="2.Docker 安装 ES"></a>2.Docker 安装 ES</h1><pre class="line-numbers language-none"><code class="language-none">//1.搜索ElasticSearch镜像
docker search elasticsearch

//2.拉取镜像
// 可以在dockerhub官网搜索具体的版本号：https://hub.docker.com/_/elasticsearch?tab=tags&amp;page=1&amp;ordering=last_updated
docker pull docker.io/elasticsearch:7.8.0 (版本号)

//3.查看镜像
docker images

//4.运行容器
// ES_JAVA_OPTS： 设置为服务器内存的一半
docker run --name fyt-es -p 9200:9200 -p 9300:9300 -e  "ES_JAVA_OPTS=-Xms8g -Xmx8g"  -d 121454ddad72<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="ES插件安装"><a href="#ES插件安装" class="headerlink" title="ES插件安装"></a>ES插件安装</h1><pre class="line-numbers language-none"><code class="language-none">// 安装插接
// 方法1
bin/elasticsearch-plugin install analysis-icu(插件名称)
// 方法2
./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.8.0/elasticsearch-analysis-ik-7.8.0.zip

// 查看所有插接
// 1.进入elasticsearch文件夹查看插件
bin/elasticsearch-plugin list

// 2.使用浏览器访问
http://120.25.168.102:9200/_cat/plugins

// 3.移除插件
./bin/elasticsearch-plugin remove analysis-icu(插件名称)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、基础概念、原理"><a href="#二、基础概念、原理" class="headerlink" title="二、基础概念、原理"></a>二、基础概念、原理</h2><h1 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h1><p>大概介绍一下ES中的一些基础概念和原理。</p>
<hr>
<h1 id="索引原理-反向索引"><a href="#索引原理-反向索引" class="headerlink" title="索引原理:反向索引"></a>索引原理:反向索引</h1><ul>
<li>正向索引</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">在搜索引擎中每个文件都对应一个文件ID，文件内容被表示为一系列关键词的集合（实际上在搜索引擎索引库中，关键词也已经转换为关键词ID）。例如“文档1”经过分词，提取了20个关键词，每个关键词都会记录它在文档中的出现次数和出现位置。

得到正向索引的结构如下：

       “文档1”的ID &gt; 单词1：出现次数，出现位置列表；单词2：出现次数，出现位置列表；…………。

       “文档2”的ID &gt; 此文档出现的关键词列表。
       
       DOC1-&gt;关键词1 -&gt;关键词2 -&gt;关键词3
       DOC2-&gt;关键词1 -&gt;关键词2 -&gt;关键词3
       DOC3-&gt;关键词1 -&gt;关键词2 -&gt;关键词3
       
       
一般是通过key，去找value。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>搜索关键词“华为手机”时，假设只存在正向索引（forward index），那么就需要扫描索引库中的所有文档，找出所有包含关键词“华为手机”的文档，再根据打分模型进行打分，排出名次后呈现给用户。</strong></p>
<ul>
<li>反向索引</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">即把文件ID对应到关键词的映射转换为关键词到文件ID的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词。

得到倒排索引的结构如下：

       “关键词1”：“文档1”的ID，“文档2”的ID，…………。

       “关键词2”：带有此关键词的文档ID列表。
       
       关键词1-&gt;doc1-&gt;doc2-&gt;doc3
       关键词2-&gt;doc1-&gt;doc2-&gt;doc3
       关键词3-&gt;doc1-&gt;doc2-&gt;doc3
       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>反向索引，把文件ID对应到关键词的映射转换为关键词到文件ID的映射，每个关键词都对应着一系列的文件，这些文件中都出现这个关键词,不需要遍历整个文档库</strong></p>
<p><strong>单词词典</strong>是倒排索引中非常重要的组成部分，它用来维护文档集合中出现过的所有单词的相关信息，同时用来记载某个单词对应的倒排列表在倒排文件中的位置信息,常用的数据结构包括<strong>哈希加链表结构</strong>和<strong>树形词典结构</strong>。</p>
<h1 id="Document-文档"><a href="#Document-文档" class="headerlink" title="Document 文档"></a>Document 文档</h1><pre class="line-numbers language-none"><code class="language-none">{
	"index": "movies",
	"_type": "_doc",
	"_id": "1",
	"_score": "14.69302",
	"_source": {
		"year": 1995,
		"@version": "1",
		"genre" : [
			"Adventure",
			"Animation",
			"Children",
			"Comedy",
			"Fantasy"
		],
		"id" : "1",
		"title" : "Toy Story"
	} 
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>_index 文档 所属的索引名</li>
<li>_type 文档所属的类型名</li>
<li>_id 文档唯一 的ID</li>
<li>_source 文档的原始 Json 数据</li>
<li>_all 整合所有字段内容到该字段 ， 已经被废除</li>
<li>_version 文档版本信息</li>
<li>_scoure 相关性打分</li>
</ul>
<h1 id="Index-索引"><a href="#Index-索引" class="headerlink" title="Index 索引"></a>Index 索引</h1><p><strong>索引是 文档的容器， 是一类 文档的结合</strong></p>
<ul>
<li>index 体现了逻辑空间的概念， 每个索引都有自己的 Mapping 定义， 用于定义包含的文档的字段名和字段类型</li>
<li>Shard 体现了 屋里空间的概念，索引中的数据分散在 Shard 上</li>
</ul>
<p><strong>索引的 Mapping 和 Settings</strong></p>
<ul>
<li>Mapping 定义文档字段的类型</li>
<li>Setting 定义不同的数据分布</li>
</ul>
<h1 id="和关系型数据库比较"><a href="#和关系型数据库比较" class="headerlink" title="和关系型数据库比较"></a>和关系型数据库比较</h1><table>
<thead>
<tr>
<th>概念</th>
<th>数据库</th>
<th>ES</th>
</tr>
</thead>
<tbody><tr>
<td>容器</td>
<td>Table</td>
<td>Index</td>
</tr>
<tr>
<td>结构定义</td>
<td>Schema</td>
<td>Mapping</td>
</tr>
<tr>
<td>数据实体</td>
<td>Row</td>
<td>Document</td>
</tr>
<tr>
<td>列</td>
<td>Column</td>
<td>Field</td>
</tr>
<tr>
<td>查询方式</td>
<td>SQL</td>
<td>DSL</td>
</tr>
</tbody></table>
<h1 id="score文档权重"><a href="#score文档权重" class="headerlink" title="_score文档权重"></a>_score文档权重</h1><p>使用ES时，对于查询出的文档无疑会有文档相似度之别。而理想的排序是和查询条件相关性越高排序越靠前，而这个排序的依据就是_score</p>
<ul>
<li>学习网址：<a target="_blank" rel="noopener" href="https://blog.csdn.net/paditang/article/details/79098830">https://blog.csdn.net/paditang/article/details/79098830</a></li>
</ul>
<h1 id="ES目录结构"><a href="#ES目录结构" class="headerlink" title="ES目录结构"></a>ES目录结构</h1><ul>
<li>bin 二进制脚本文件包括elasticsearch启动节点、elasticsearch-plugin安装插件</li>
<li>conf 配置文件 包括elasticsearch.yml</li>
<li>data 在节点上分配的每个index/shard的数据文件的位置，可以容纳多个位置</li>
<li>logs 日志文件的位置</li>
<li>plugins 插件文件的位置，每个插件将包含在其子目录中</li>
<li>repo 共享文件系统存储库位置。可容纳多个位置。文件系统存储库可以放在这里指定的任何目录的任何子目录中</li>
<li>script 脚本文件的位置</li>
</ul>
<h2 id="三、Kibana安装"><a href="#三、Kibana安装" class="headerlink" title="三、Kibana安装"></a>三、Kibana安装</h2><h1 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h1><p>Kibana是一个针对Elasticsearch的开源分析及可视化平台，用来搜索、查看交互存储在Elasticsearch索引中的数据。使用Kibana，可以通过各种图表进行高级数据分析及展示。 Kibana让海量数据更容易理解。它操作简单，基于浏览器的用户界面可以快速创建仪表板（dashboard）实时显示Elasticsearch查询动态。 设置Kibana非常简单。无需编码或者额外的基础架构，几分钟内就可以完成Kibana安装并启动Elasticsearch索引监测。</p>
<hr>
<h1 id="linux环境搭建-Kibana"><a href="#linux环境搭建-Kibana" class="headerlink" title="linux环境搭建 Kibana"></a>linux环境搭建 Kibana</h1><ul>
<li>Docker 安装</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 安装
docker pull docker.elastic.co/kibana/kibana:7.10.0
# 启动
docker run  -d --name kibana -p 5601:5601 docker.elastic.co/kibana/kibana:7.10.0
# 修改kibana.yml 配置
docker exec -it kibana <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>本地安装</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">wget https://artifacts.elastic.co/downloads/kibana/kibana-6.3.2-linux-x86_64.tar.gz

tar -zxvf kibana-6.3.2-linux-x86_64.tar.gz
mv kibana-6.3.2-linux-x86_64/ /usr/local/kibana

-- 不能root执行，改成es
chown -R es kibana<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>修改配置</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">-- vim config/kibana.yml

server.port: 5601
server.host: "0.0.0.0"
elasticsearch.url: "http://192.168.202.128:9200"
kibana.index: ".kibana"

-- 修改为中文
i18n.locale: "en" 改为 i18n.locale: "zh-CN"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>启动</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">bin/kibana 

-- 挂起到后台执行
./bin/kibana &amp; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>停止</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">fuser -n tcp 5601
kill 进程<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="四、Mapping-数据类型"><a href="#四、Mapping-数据类型" class="headerlink" title="四、Mapping 数据类型"></a>四、Mapping 数据类型</h2><h1 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h1><p>ES的mapping非常类似于静态语言中的数据类型：声明一个变量为int类型的变量， 以后这个变量都只能存储int类型的数据。同样的， 一个number类型的mapping字段只能存储number类型的数据。 同语言的数据类型相比，mapping还有一些其他的含义，mapping不仅告诉ES一个field中是什么类型的值， 它还告诉ES如何索引数据以及数据是否能被搜索到。</p>
<hr>
<h2 id="1-Dynamic-Mapping-字段"><a href="#1-Dynamic-Mapping-字段" class="headerlink" title="1.Dynamic Mapping 字段"></a>1.Dynamic Mapping 字段</h2><ul>
<li>动态映射(dynamic: true)，动态添加新的字段（或缺省）。</li>
<li>静态映射(dynamic:false)，忽略新的字段。在原有的映射基础上，当有新的字段时，不会主动的添加新的映射关系，只作为查询结果出现在查询中。</li>
<li>严格模式(dynamic：strict)，如果遇到新的字段，就抛出异常。</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>true</th>
<th>false</th>
<th>strict</th>
</tr>
</thead>
<tbody><tr>
<td>文档可索引</td>
<td>YES</td>
<td>YES</td>
<td>NO</td>
</tr>
<tr>
<td>字段可索引</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
</tr>
<tr>
<td>mapping被更新</td>
<td>YES</td>
<td>NO</td>
<td>NO</td>
</tr>
</tbody></table>
<p><strong>修改语句</strong></p>
<pre class="line-numbers language-none"><code class="language-none">PUT dynamic_test/_mapping
{
  "dynamic": false
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-数据类型"><a href="#2-数据类型" class="headerlink" title="2.数据类型"></a>2.数据类型</h2><p><strong>核心数据类型</strong></p>
<ul>
<li>字符串 text：用于全文索引，该类型的字段将通过分词器进行分词 keyword：不分词，只能搜索该字段的完整的值</li>
<li>数值型 long、integer、short、byte、double、float、half_float、scaled_float</li>
<li>布尔 boolean</li>
<li>二进制 binary：该类型的字段把值当做经过base64编码的字符串，默认不存储，且不可搜索</li>
<li>范围类型 范围类型表示值是一个范围，而不是一个具体的值 integer_range、float_range、long_range、double_range、date_range 比如age类型是integer_range，那么值可以是{“gte”:20,”lte”:40}；搜索”term”:{“age”:21}可以搜索该值</li>
<li>日期-date\ 由于json类型没有date类型，所以es通过识别字符串是否符合format定义的格式来判断是否为date类型\ format默认为：strict_date_optional_time || epoch_millis\ 格式”2022-01-01” “2022/01/01 12:10:30” \ 这种字符串格式\ 从开始纪元（1970年1月1日0点）开始的毫秒数</li>
</ul>
<p><strong>复杂数据类型</strong> ES中没有专门的数据类型，直接使用[]定义接口，数组中所有的值必须是同一种数据类型，不支持混合数据类型的数组</p>
<ul>
<li>字符串数组[“one”,”two”]</li>
<li>整数数组[1,2]</li>
<li>Object对象数组[{“name”:”alex”,”age”:18},{“name”:”tom”,”age”:18}]</li>
</ul>
<p><strong>专用数据类型</strong></p>
<ul>
<li>IP类型的字段用于存储IPv4和IPv6的地址，本质上是一个长整形字段</li>
<li>completion（实现自动补全）</li>
<li>token_count（记录分词数）</li>
<li>murmur3（记录字符串hash值）</li>
</ul>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><pre class="line-numbers language-none"><code class="language-none"># 创建
PUT my_index
{
  "mappings": {
    "doc": {
      "dynamic": false,
      "properties": {
        "title": {
          "type": "text"
        },
        "name": {
          "type": "keyword"
        },
        "age": {
          "type": "integer"
        }
      }
    }
  }
}

#查询
GET my_index/_mapping<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-index参数"><a href="#3-index参数" class="headerlink" title="3.index参数"></a>3.index参数</h2><p>index参数作用是控制当前字段是否被<strong>索引</strong>，默认为true，false表示不记录，即不可被搜索。</p>
<pre class="line-numbers language-none"><code class="language-none">PUT my_index5
{
  "mappings": {
    "doc": {
      "properties": {
        "cookie": {
          "type": "text",
          "index": false
        },
        "content": {
          "type": "text",
          "index": true
        }
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个index有两个字段，其中cookie设定为不可被搜索\ <strong>当在es中存储了一些不想要被检索的字段如身份证、手机等，这是对于这些字段就可以使用index设置为false，这样有一定的安全性还可以节省空间</strong></p>
<h2 id="4-null-value参数"><a href="#4-null-value参数" class="headerlink" title="4.null_value参数"></a>4.null_value参数</h2><p>这个参数的作用是当字段遇到null值的时候的处理策略，默认为null，即空值，此时es会忽略该值。可以通过这个参数设置某个字段的默认值。</p>
<pre class="line-numbers language-none"><code class="language-none">PUT my_index5
{
  "mappings": {
    "doc": {
      "properties": {
        "cookie": {
          "type": "text",
          "null_value":"Null"
        }
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-Index-template"><a href="#5-Index-template" class="headerlink" title="5.Index template"></a>5.Index template</h2><ul>
<li>Index Templates - 帮助设定Mapping 和 Settings，并按照一定的规则，自动匹配到新创建的索引上</li>
<li>模板仅在一个索引被新创建时，才会产生作用，修改模版不会影响已创建的索引。</li>
<li>可以设定多个索引模版，这些设置会被”merge”在一起</li>
<li>可以指定”order”的数值，控制”merging”的过程</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">所有索引在创建的时候 都会把setting设置成主分片和副本分片都是1
# 案列1
   PUT  _template/template_default
   {
     "index_patterns":["*"],
     "order" : 0,
     "version" : 1,
     "settings" : {
  		"number_of_shards" : 1,
  		"number_of_replicas": 1
  	}
  }


#  案列2 
PUT _template/fy_office_template
{
  # 匹配的索引名字
  "index_patterns":["fy_office_list*"],
  "order": 0,
  "settings": {
  # 设置分词器 
   "analysis":{   
      "analyzer":{
          "ik":{
            "tokenizer":"ik_max_word"
          }
        }
    },
    # 刷新频率
    "refresh_interval": "30s",
    "translog":{
      "sync_interval":"30s",
      "durability": "async"
    }
  },
  "mappings" : {
      "properties" : {
        "address" : {
          "type" : "keyword"
        },
        "province" : {
          "type" : "keyword"
        },
        "web_url" : {
          "type" : "keyword"
        },
        "city" : {
          "type" : "keyword"
        },
        "county" : {
          "type" : "keyword"
        },
        "name" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "ignore_above" : 256,
              "type" : "keyword"
            }
          }
        },
        "tel" : {
          "type" : "keyword"
        },
        "id" : {
          "type" : "integer"
        },
        "fax" : {
          "type" : "keyword"
        },
        "email" : {
          "type" : "keyword"
        }
      }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Index template的工作方式</strong></p>
<ul>
<li>当一个索引被新创建时</li>
<li>应用Elasticsearch 默认的setting和mappings</li>
<li>应用order 数值低的 Index Template 中设定</li>
<li>应用order 高的Index Template 中设定，之前的设定会被覆盖</li>
<li>应用创建索引时，用户所指定的setting和mappings，并覆盖之前 模版中的设定</li>
</ul>
<h2 id="6-Dynamic-Template"><a href="#6-Dynamic-Template" class="headerlink" title="6.Dynamic Template"></a>6.Dynamic Template</h2><p>根据Elasticsearch 识别的数据类型，结合字段名称，来动态设定字段类型</p>
<ul>
<li>Dynamic Template 是定义在某个索引的mapping中</li>
<li>Template有一个名称</li>
<li>匹配规则是一个数组</li>
<li>为匹配都字段设置Mapping</li>
</ul>
<h1 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h1><ul>
<li>1：keword是一种字段类型 es的每个字段可以做多字段，例如，你有一个content的字段，类型是text。你可以为他指定一个子字段叫 keyword（也可以取名字叫kw）类型设置成keword， 在做term查询时，就查询content.keyword（或者叫content.kw。 es默认为所有文本都设置成text，并且设置keywoed的子字段</li>
<li>2： mapping信息是保存在cluster state里面的。 文件应该放在 nodes/{N}/_state/global-{NNN} 下面 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-state.html</a></li>
<li>3：使用动态mapping的隐患 设置成strict，万一有一条数据里带着不存在的字段，写入就会失败。 设置成true，数据可以写入，还会在mapping中增加那个字段的设置。随着时间的流逝，这类数据会导致mapping设定的膨胀</li>
<li>4：选择使用ES的场景，及同步数据的思路 如果有全文搜索的需求。或者有统计分析的需求，都可以用es作为存储。数据可以在数据库里保存一份，定期同步到es中。然后对一些全文搜索的，对应es实现。 数据库和es同步可以考虑使用logstash的jdbc connector。只需要配置就可以实现增量同步。对于物理删除的记录如何同步es，在logstash中不支持这个功能。但是可以通过为数据增加isDeleted字段的方式。标记成删除状态。同步到es后 再用程序分别删除。</li>
</ul>
<h2 id="五、分片，副本管理"><a href="#五、分片，副本管理" class="headerlink" title="五、分片，副本管理"></a>五、分片，副本管理</h2><h1 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h1><p>分片，副本 是ES中一个重要的概念</p>
<hr>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><ul>
<li>**集群(Cluster)**：集群是一个或多个节点（服务器）的集合，它们共同保存您的整个数据，并提供跨所有节点的联合索引和搜索功能。本质上是一个分布式数据库，允许多台服务器协同工作，每台服务器可以运行多个 Elastic 实例。单个 Elastic 实例称为一个节点（node）。一组节点构成一个集群（cluster）。</li>
<li><strong>节点（Node）</strong>：节点是作为集群一部分的单个服务器，存储数据并参与群集的索引和搜索功能。</li>
<li><strong>索引（Index）</strong>：索引是具有某些类似特征的文档集合。索引由名称标识（必须全部小写），此名称用于在对其中的文档执行索引，搜索，更新和删除操作时引用索引。 数据管理的顶层单位就叫做 Index（索引）。它是单个数据库的同义词。每个 Index （即数据库）的名字必须是小写。</li>
<li><strong>文档（Document）</strong>：文档是可以编制索引的基本信息单元。Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。Document 使用 JSON 格式表示，同一个 Index 里面的 Document，不要求有相同的结构（scheme），但是最好保持相同，这样有利于提高搜索效率。</li>
<li><strong>分片和副本（Shards &amp; Replicas）</strong>：索引可能存储大量可能超过单个节点的硬件限制的数据。为了解决这个问题，Elasticsearch提供了将索引细分为多个称为分片的功能。创建索引时，只需定义所需的分片数即可。每个分片本身都是一个功能齐全且独立的“索引”，可以托管在集群中的任何节点上。<strong>一个分片默认最大文档数量是20亿，每个分片最好不超过30GB</strong></li>
<li><strong>副本集很重要</strong>：它在分片/节点发生故障时提供高可用性。它允许您扩展搜索量/吞吐量，因为可以在所有副本上并行执行搜索。默认情况下，Elasticsearch中的每个索引都分配了5个主分片和1个副本，这意味着如果群集中至少有两个节点，则索引将包含5个主分片和另外5个副本分片（1个完整副本），总计为每个索引10个分片。 (7.0 版本改为默认1个主分片，0个副本分片)</li>
</ul>
<hr>
<p>索引的number_of_shards参数只对当前索引有效而不是对整个集群生效.对每个索引来讲, 该参数定义了当前索引的主分片数(而不是集群中所有的主分片数).</p>
<h1 id="文档到路由的算法"><a href="#文档到路由的算法" class="headerlink" title="文档到路由的算法"></a>文档到路由的算法</h1><p>当你索引一个文档，它被存储在单独一个主分片上。Elasticsearch是如何知道文档属于哪个分片的呢？当你创建一个新文档，它是如何知道是应该存储在分片1还是分片2上的呢？</p>
<p>进程不能是随机的，因为我们将来要检索文档。事实上，它根据一个简单的算法决定：</p>
<p><strong>shard = hash(routing) % number_of_primary_shards</strong> \ routing值是一个任意字符串，它默认是_id但也可以自定义。这个routing字符串通过哈希函数生成一个数字，然后除以主切片的数量得到一个余数(remainder)，余数的范围永远是0到number_of_primary_shards - 1，这个数字就是特定文档所在的分片。</p>
<p><strong>这也解释了为什么主分片的数量只能在创建索引时定义且不能修改：如果主分片的数量在未来改变了，所有先前的路由值就失效了</strong>，文档也就永远找不到了。</p>
<h1 id="集群状态"><a href="#集群状态" class="headerlink" title="集群状态"></a>集群状态</h1><ul>
<li>绿色：一起正常，主分片副本分片都正常使用</li>
<li>黄色 ：主分片都可以正常访问，有部分副本分片无法使用</li>
<li>黄色：有部分主分片无法使用</li>
</ul>
<h1 id="案列"><a href="#案列" class="headerlink" title="案列"></a>案列</h1><ul>
<li>索引创建后就不能修改主分片，(需要重建索引)</li>
<li>副本分片个数可以随时调整</li>
<li>当其中节点出现无法访问时，副本分片会自动竞选成为主分片，确保系统正常运行</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 创建索引
PUT demo1
{
  "mappings": {
    "properties": {
      "name":{
        "type": "keyword"
      },
      "address":{
        "type": "text"
      },
      "memo":{
        "type": "text"
      }
    }
  },
  "settings": {
    "number_of_shards": 3,    // 设置主分片个数 (索引创建后就不能修改)
    "number_of_replicas": 1   // 设置副本分片个数（相当于所有的主分片都会被）
  }
  
}


POST demo1/_doc
{
  "name":"阿龙",
  "address":"湖南长沙",
  "memo":"test1"
}

POST demo1/_doc
{
  "name":"阿俊",
  "address":"湖南株洲",
  "memo":"test2"
}



# 设置分片

PUT /demo1
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1
  }
}


# 设置副本数,每个节点只会生成一个副本

PUT demo1/_settings
{
  "number_of_replicas": 4
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="推迟分配分片"><a href="#推迟分配分片" class="headerlink" title="推迟分配分片"></a>推迟分配分片</h1><p>当有节点无法访问时，master节点会进行分片的**reallocation(重新分配)**。</p>
<p>理论上来说，这个是理想的行为，我们想要提拔副本分片来尽快恢复丢失的主分片。 我们同时也希望保证资源在整个集群的均衡，用以避免热点。 然而，在实践中，立即的再均衡所造成的问题会比其解决的更多。举例来说，考虑到以下情形：</p>
<ul>
<li>Node（节点） 19 在网络中失联了（某个家伙踢到了电源线)</li>
<li>Master 立即注意到了这个节点的离线，它决定在集群内提拔其他拥有 Node 19 上面的主分片对应的副本分片为主分片</li>
<li>在副本被提拔为主分片以后，master 节点开始执行恢复操作来重建缺失的副本。集群中的节点之间互相拷贝分片数据，网卡压力剧增，集群状态尝试变绿。</li>
<li>由于目前集群处于非平衡状态，这个过程还有可能会触发小规模的分片移动。其他不相关的分片将在节点间迁移来达到一个最佳的平衡状态 与此同时，那个踢到电源线的倒霉管理员，把服务器插好电源线进行了重启，现在节点 Node 19 又重新加入到了集群。不幸的是，这个节点被告知当前的数据已经没有用了， 数据已经在其他节点上重新分配了。所以 Node 19 把本地的数据进行删除，然后重新开始恢复集群的其他分片（然后这又导致了一个新的再平衡）</li>
</ul>
<p>如果这一切听起来是不必要的且开销极大，那就对了。是的，不过前提是你知道这个节点会很快回来。如果节点 Node 19 真的丢了，上面的流程确实正是我们想要发生的。</p>
<p>为了解决这种瞬时中断的问题，Elasticsearch 可以推迟分片的分配。这可以让你的集群在重新分配之前有时间去检测这个节点是否会再次重新加入。</p>
<p><strong>修改默认延时</strong></p>
<pre class="line-numbers language-none"><code class="language-none">默认情况，集群会等待一分钟来查看节点是否会重新加入，如果这个节点在此期间重新加入，重新加入的节点会保持其现有的分片数据，不会触发新的分片分配。

通过修改参数 delayed_timeout ，默认等待时间可以全局设置也可以在索引级别进行修改:
PUT /_all/_settings 
{
  "settings": {
    "index.unassigned.node_left.delayed_timeout": "5m"  （如果你希望分片立即分配而不想等待,可以设置成0）
  }
}


	
通过使用 _all 索引名，我们可以为集群里面的所有的索引使用这个参数

默认时间被修改成了 5 分钟<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>自动取消分配迁移</strong></p>
<p>如果节点在超时之后再回来，且集群还没有完成分片的移动，会发生什么事情呢？在这种情形下， Elasticsearch 会检查该机器磁盘上的分片数据和当前集群中的活跃主分片的数据是不是一样 — 如果两者匹配， 说明没有进来新的文档，包括删除和修改 — 那么 master 将会取消正在进行的再平衡并恢复该机器磁盘上的数据。</p>
<p>之所以这样做是因为本地磁盘的恢复永远要比网络间传输要快，并且我们保证了他们的分片数据是一样的，这个过程可以说是双赢。</p>
<p>如果分片已经产生了分歧（比如：节点离线之后又索引了新的文档），那么恢复进程会继续按照正常流程进行。重新加入的节点会删除本地的、过时的数据，然后重新获取一份新的。</p>
<h1 id="分片生命周期"><a href="#分片生命周期" class="headerlink" title="分片生命周期"></a>分片生命周期</h1><ul>
<li>1）客户端发起数据写入请求，对你写的这条数据根据<em>routing规则选择发给哪个Shard。 确认Index Request中是否设置了使用哪个Filed的值作为路由参数， 如果没有设置，则使用Mapping中的配置， 如果mapping中也没有配置，则使用</em>id作为路由参数，然后通过_routing的Hash值选择出Shard，最后从集群的Meta中找出出该Shard的Primary节点。</li>
<li>2）写入请求到达Shard后，先把数据写入到内存（buffer）中，同时会写入一条日志到translog日志文件中去。 当写入请求到shard后，首先是写Lucene，其实就是创建索引。 索引创建好后并不是马上生成segment，这个时候索引数据还在缓存中，这里的缓存是lucene的缓存，并非Elasticsearch缓存，lucene缓存中的数据是不可被查询的。</li>
<li>3）执行refresh操作：从内存buffer中将数据写入os cache(操作系统的内存)，产生一个segment file文件，buffer清空。 写入os cache的同时，建立倒排索引，这时数据就可以供客户端进行访问了。 默认是每隔1秒refresh一次的，所以es是准实时的，因为写入的数据1秒之后才能被看到。 buffer内存占满的时候也会执行refresh操作，buffer默认值是JVM内存的10%。 通过es的restful api或者java api，手动执行一次refresh操作，就是手动将buffer中的数据刷入os cache中，让数据立马就可以被搜索到。 若要优化索引速度, 而不注重实时性, 可以降低刷新频率。</li>
<li>4）translog会每隔5秒或者在一个变更请求完成之后，将translog从缓存刷入磁盘。 translog是存储在os cache中，每个分片有一个，如果节点宕机会有5秒数据丢失，但是性能比较好，最多丢5秒的数据。。 可以将translog设置成每次写操作必须是直接fsync到磁盘，但是性能会差很多。 可以通过配置增加transLog刷磁盘的频率来增加数据可靠性，最小可配置100ms，但不建议这么做，因为这会对性能有非常大的影响。</li>
<li>5）每30分钟或者当tanslog的大小达到512M时候，就会执行commit操作（flush操作），将os cache中所有的数据全以segment file的形式，持久到磁盘上去。 第一步，就是将buffer中现有数据refresh到os cache中去。 清空buffer 然后强行将os cache中所有的数据全都一个一个的通过segmentfile的形式，持久到磁盘上去。 将commit point这个文件更新到磁盘中，每个Shard都有一个提交点(commit point), 其中保存了当前Shard成功写入磁盘的所有segment。 把translog文件删掉清空，再开一个空的translog文件。 flush参数设置： index.translog.flush_threshold_period: index.translog.flush_threshold_size: #控制每收到多少条数据后flush一次 index.translog.flush_threshold_ops:</li>
<li>6）Segment的merge操作： 随着时间，磁盘上的segment越来越多，需要定期进行合并。 Es和Lucene 会自动进行merge操作，合并segment和删除已经删除的文档。 我们可以手动进行merge：POST\ index/_forcemerge。一般不需要，这是一个比较消耗资源的操作。</li>
</ul>
<h2 id="六、查询模板，索引别名"><a href="#六、查询模板，索引别名" class="headerlink" title="六、查询模板，索引别名"></a>六、查询模板，索引别名</h2><h1 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h1><p>我们发现一些用户经常编写了一些非常冗长和复杂的查询 - 在很多情况下，相同的查询会一遍又一遍地执行，但是会有一些不同的值作为参数来查询。在这种情况下，我们觉得使用一个search template（搜索模板）来做这样的工作非常合适。搜索模板允许您使用可在执行时定义的参数定义查询</p>
<hr>
<h1 id="1-查询模板Search-template"><a href="#1-查询模板Search-template" class="headerlink" title="1.查询模板Search template"></a>1.查询模板Search template</h1><p>Search template的好处是：</p>
<ul>
<li>避免在多个地方重复代码</li>
<li>更容易测试和执行您的查询</li>
<li>在应用程序间共享查询</li>
<li>允许用户只执行一些预定义的查询</li>
<li>将搜索逻辑与应用程序逻辑分离</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 创建 Search Template 查询模板
POST _scripts/tmdbFind
{
  "script":{
    "lang": "mustache",
    "source": {
      "_source":["title","overview"], 
      "size": 20, 
      "query": {
        "multi_match": {
          "query": "{{q}}",
          "fields": ["title^2","overview"]
        }
      }
    }
  }
}

# tmdbFind 为查询模板的ID，可以在多个索引中使用这个模板

# 使用查询模板
POST tmdb/_search/template
{
  "id":"tmdbFind",
  "params": {
    "q":"Coach and Carter"
  }
}

# 查看模板
GET _scripts/searchTitle

# 删除模板
DELETE _scripts/searchTitle<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="2-索引别名-alias"><a href="#2-索引别名-alias" class="headerlink" title="2.索引别名 alias"></a>2.索引别名 alias</h1><p>别名。别名正如其名，他们是你使用的指针或者名称，对于1个或多个具体的所有。由于其提供的灵活性，别名再扩展集群和管理数据在索引中的分布时是非常有用的</p>
<ul>
<li>（1）灵活的扩容：推荐每个人为他们的Elasticsearch所以使用别名，因为在未来重建索引的时候，别名会赋予你更多的灵活性。假设一开始创建索引只有一个主分片，之后你又决定为索引扩容。如果为原索引使用的是别名，现在你可以修改别名让其指向额外创建的新索引，而无须修改被搜索的索引之名称（假设一开始你就为搜索使用了别名）。</li>
<li>（2）动态的滚动查询：在实际应用中，我们也不应该向单个索引持续写入数据，知道它的分片巨大无比。巨大的索引会在数据老化后难以删除，以——id为单位删除文档不会立即释放空间，删除doc只在lucene分段合并时才会真正从磁盘中删除。即使手工触发分段合并，仍会引起较高的I/O压力，并且可能因为分段巨大导致合并过程中磁盘空间不足（分段大小大于此片可用空间的一半）</li>
</ul>
<p>因此，另外一个有用的特性是：在不同的索引创建窗口。比如，如果为数据创建了每日索引，你可能期望一个滑动窗口覆盖过去一周的数据，别名就称为last-7-days.然后，每天创建新的每日索引时，将其加入别名，同时删除第8天前的旧索引。</p>
<p>这样，对于业务方来说，读取时使用的别名不变，当需要删除数据的时候，可以直接删除整个索引</p>
<ul>
<li>（3）进行索引分组</li>
<li>（4）使用别名过滤器来屏蔽文档，他们可以对正在执行的查询自动地实施过滤</li>
<li>（5）结合别名和路由，在查询或索引得时候自动地使用路由值。</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 创建别名
POST _aliases
{
  "actions": [
    {
      "add": {
        "index": "tmdb",
        "alias": "movies-last",
        "filter": {    # 查询条件，可选
          "range": {
            "id": {
              "gte": 8000,
              "lte": 8200
            }
          }
        }
      }
    }
  ]
}

# 使用别名查询
GET movies-last/_search
{
  "_source": ["id","title"], 
  "query": {
    "match_all": {}
  }
}


# 当每天创建一个索引时，动态设置好别名，查询的操作就不需要做改动。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="七、分词器"><a href="#七、分词器" class="headerlink" title="七、分词器"></a>七、分词器</h2><h1 id="简介-6"><a href="#简介-6" class="headerlink" title="简介"></a>简介</h1><p>文本分析是指将文本进行特定的过滤、分词和转换的过程。 在es进行倒排索引和进行文本搜索时，都可以预先对文本进行文本分析，经过文本分析后的结果会最后被建进倒排索引或者被发送进行真正的查询。</p>
<hr>
<p><strong>一段文本分词的步骤经过如下：</strong></p>
<ul>
<li>字符过滤器 char_filter,字符级别过滤</li>
<li>分词器 tokenizer,基于规则或语义切分</li>
<li>分词过滤器 filter，禁用词吗，同义词，大小写 等处理</li>
</ul>
<p><img src="http://dl2.iteye.com/upload/attachment/0113/2519/6d5a46ad-568e-38b9-a3b0-bb56a0b47229.png" alt="image"></p>
<h2 id="内置分词器"><a href="#内置分词器" class="headerlink" title="内置分词器"></a>内置分词器</h2><p><strong>Standard Analyzer</strong></p>
<p>根据Unicode Text Segmentation algorithm对文本进行分词，移除大多数的标点符号，将文本转为小写，并将停止词去掉。</p>
<p><strong>Simple Analyzer</strong></p>
<p>遇到非字母的符号就切分文本，并且将大写字母转为小写。</p>
<p><strong>Whitespace Analyzer</strong></p>
<p>以空白字符为切割符分割文本，不会进行大小写转换。</p>
<p><strong>Stop Analyzer</strong></p>
<p>与Simple Analyzer行为很像，只是在分词过程中过滤了停止词。</p>
<p><strong>Keyword AnalyzerT</strong></p>
<p>不对字段进行分词，将整个字段当做一个单独的分词。</p>
<p><strong>Pattern Analyzer</strong></p>
<p>允许指定一个分词切分的模式，同时支持大写字母转为小写和停止词过滤；</p>
<p><strong>Language Analyzers</strong></p>
<p>特定语言的分析器，需要指定语言。比如english 、french。</p>
<p><strong>Fingerprint Analyzer</strong></p>
<p>该分词器将输入的文本转为小写，并过滤重复的词，最后再将过滤的词重新组成文本。如果有定义停止词，那么也会移除停止词。</p>
<h2 id="IK分词器"><a href="#IK分词器" class="headerlink" title="IK分词器"></a>IK分词器</h2><ul>
<li>安装方法1<ul>
<li>1、去github 下载对应的分词插件 <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a> 根据不同版本下载不同的分词插件</li>
<li>2、到es的plugins 目录创建文件夹 cd your-es-root/plugins/ &amp;&amp; mkdir ik</li>
<li>3、解压ik分词插件到ik文件夹 unzip elasticsearch-analysis-ik-6.4.3.zip</li>
</ul>
</li>
<li>方法2<ul>
<li>./bin/elasticsearch-plugin install <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</a> （替换自己的版本号:7.1.0）</li>
<li>安装后重启elasticsearch</li>
</ul>
</li>
</ul>
<hr>
<p><strong>简介</strong></p>
<ul>
<li>Elasticsearch中文分词我们采用Ik分词，ik有两种分词模式，<strong>ik_max_word</strong>,和<strong>ik_smart</strong>模式;</li>
<li><strong>ik_max_word</strong>: 会将文本做最细粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,中华人民,中华,华人,人民共和国,人民,人,民,共和国,共和,和,国国,国歌”，会穷尽各种可能的组合；</li>
<li><strong>ik_smart</strong>: 会做最粗粒度的拆分，比如会将“中华人民共和国国歌”拆分为“中华人民共和国,国歌”。</li>
</ul>
<hr>
<p><strong>实例</strong></p>
<pre class="line-numbers language-none"><code class="language-none">-- 设置mapping时，定义分词器
GET test_chinese/_mapping/doc
{
  "properties":{
    "content":{
      "type":"text",
      "analyzer":"ik_max_word",
      "search_analyzer":"ik_smart"
    }
  }
}


-- ik_max_word 分词
GET /_analyze
{
  "analyzer": "ik_max_word",
  "text": "海燕在苍茫的大海上高傲的飞翔"
}

-- ik_smart 分词
GET /_analyze
{
  "analyzer": "ik_smart",
  "text": "海燕在苍茫的大海上高傲的飞翔"
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>自定义词典</strong></p>
<pre class="line-numbers language-none"><code class="language-none">配置文件IKAnalyzer.cfg.xml。
如果是在线安装方式IKAnalyzer.cfg.xml的位置在{conf}/analysis-ik/IKAnalyzer.cfg.xml
离线安装在{plugins}/elasticsearch-analysis-ik-*/config/IKAnalyzer.cfg.xml


&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;
&lt;properties&gt;
    &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;
    &lt;!--用户可以在这里配置自己的扩展字典 --&gt;
    &lt;entry key="ext_dict"&gt;custom/mydict.dic;custom/single_word_low_freq.dic&lt;/entry&gt;
     &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
    &lt;entry key="ext_stopwords"&gt;custom/ext_stopword.dic&lt;/entry&gt;
    &lt;!--用户可以在这里配置远程扩展字典 --&gt;
    &lt;entry key="remote_ext_dict"&gt;location&lt;/entry&gt;
    &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;
    &lt;entry key="remote_ext_stopwords"&gt;http://xxx.com/xxx.dic&lt;/entry&gt;
&lt;/properties&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ik文本词典均是以dic结尾,换行符作为分隔,示例如下:</p>
<pre class="line-numbers language-none"><code class="language-none">vim myDic.dic

-- 
我爱中国
万里长城
真的想你<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改ik配置文件,将自定义的词典添加到ik配置中</p>
<pre class="line-numbers language-none"><code class="language-none">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;
&lt;properties&gt;
    &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;
    &lt;!--用户可以在这里配置自己的扩展字典 --&gt;
    &lt;entry key="ext_dict"&gt;myDic.dic&lt;/entry&gt;
     &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;
    &lt;entry key="ext_stopwords"&gt;&lt;/entry&gt;
&lt;/properties&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置好后需要重启ES</p>
<p>通过前面教程中,我们发现短语”我爱中国”,会被分词为, “我”,”爱”,”中国”三个词, 如果按照上面词典定义后, “我爱中国”会被当成一个词语不被分词。</p>
<hr>
<h2 id="Hanlp-分词器"><a href="#Hanlp-分词器" class="headerlink" title="Hanlp 分词器"></a>Hanlp 分词器</h2><ul>
<li>安装插件\ ./elasticsearch-plugin install <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.1.0/elasticsearch-analysis-ik-7.1.0.zip</a></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">#hanlp: hanlp默认分词
#hanlp_standard: 标准分词
#hanlp_index: 索引分词
#hanlp_nlp: NLP分词
#hanlp_n_short: N-最短路分词
#hanlp_dijkstra: 最短路分词
#hanlp_crf: CRF分词（在hanlp 1.6.6已开始废弃）
#hanlp_speed: 极速词典分词

POST _analyze
{
  "analyzer": "hanlp_standard",
  "text": ["剑桥分析公司多位高管对卧底记者说，他们确保了唐纳德·特朗普在总统大选中获胜"]

}     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="其他分词器"><a href="#其他分词器" class="headerlink" title="其他分词器"></a>其他分词器</h1><ul>
<li>中科院计算所NLPIR <a target="_blank" rel="noopener" href="http://ictclas.nlpir.org/nlpir/">http://ictclas.nlpir.org/nlpir/</a></li>
<li>ansj分词器 <a href="https://github.com/NLPchina/ansj_seg">https://github.com/NLPchina/ansj_seg</a></li>
<li>哈工大的LTP <a href="https://github.com/HIT-SCIR/ltp">https://github.com/HIT-SCIR/ltp</a></li>
<li>清华大学THULAC <a href="https://github.com/thunlp/THULAC">https://github.com/thunlp/THULAC</a></li>
<li>斯坦福分词器 <a target="_blank" rel="noopener" href="https://nlp.stanford.edu/software/segmenter.shtml">https://nlp.stanford.edu/software/segmenter.shtml</a></li>
<li>Hanlp分词器 <a href="https://github.com/hankcs/HanLP">https://github.com/hankcs/HanLP</a></li>
<li>结巴分词 <a href="https://github.com/yanyiwu/cppjieba">https://github.com/yanyiwu/cppjieba</a></li>
<li>KCWS分词器(字嵌入+Bi-LSTM+CRF) <a href="https://github.com/koth/kcws">https://github.com/koth/kcws</a></li>
<li>ZPar <a href="https://github.com/frcchang/zpar/releases">https://github.com/frcchang/zpar/releases</a></li>
<li>IKAnalyzer <a href="https://github.com/wks/ik-analyzer">https://github.com/wks/ik-analyzer</a></li>
</ul>
<h2 id="八、文档打分机制"><a href="#八、文档打分机制" class="headerlink" title="八、文档打分机制"></a>八、文档打分机制</h2><h1 id="简介-7"><a href="#简介-7" class="headerlink" title="简介"></a>简介</h1><p>Elasticsearch是基于Lucene的，所以它的评分机制也是基于Lucene的。在Lucene中把这种相关性称为得分（score），确定文档和查询有多大相关性的过程被称为打分（scoring）</p>
<hr>
<h2 id="TF-IDF"><a href="#TF-IDF" class="headerlink" title="TF-IDF"></a>TF-IDF</h2><p>Lucene和es的打分机制是一个公式。将查询作为输入，使用不同的手段来确定每一篇文档的得分，将每一个因素最后通过公式综合起来，返回该文档的最终得分。这个综合考量的过程，就是我们希望相关的文档被优先返回的考量过程。在Lucene和es中这种相关性称为得分。 在开始计算得分之前，es使用了被搜索词条的频率和它有多常见来影响得分，从两个方面理解：</p>
<ul>
<li>一个词条在某篇文档中出现的次数越多，该文档就越相关。</li>
<li>一个词条如果在不同的文档中出现的次数越多，它就越不相关！</li>
</ul>
<p>我们称之为TF-IDF，TF是词频（term frequency），而IDF是逆文档频率（inverse document frequency）。</p>
<p>*<strong>词频：TF*</strong> 考虑一篇文档得分的首要方式，是查看一个词条在文档中出现的次数，比如某篇文章围绕es的打分展开的，那么文章中肯定会多次出现相关字眼，当查询时，我们认为该篇文档更符合，所以，这篇文档的得分会更高。</p>
<p>TF=freq(i,j) / maxOthers(i,j)</p>
<p><strong>逆文档频率：IDF</strong> 相对于词频，逆文档频率稍显复杂，如果一个词条在索引中的不同文档中出现的次数越多，那么它就越不重要。</p>
<p>IDF = log(N /n(i))<br>N 为所有可能推荐文档的数量，n(i)为N中关键词 i 出现过得文档的数量。</p>
<p><strong>TF-IDF权值 = TF 乘 IDF</strong></p>
<h2 id="BM25"><a href="#BM25" class="headerlink" title="BM25"></a>BM25</h2><p>BM25源于概率相关模型，而非向量空间模型</p>
<p>BM25同样使用词频，逆文档频率以及字段长度归一化，但是每个因子的定义都有细微差别</p>
<p><strong>ES5 ，默认使用BM25算分，和经典的TF-IDF相比，当TF无限增加时，BM25算分会趋于一个数值</strong></p>
<p>列子：</p>
<pre class="line-numbers language-none"><code class="language-none">DELETE news
POST /news/_bulk
{ "index": { "_id": 1 }}
{ "content":"Apple Mac" }
{ "index": { "_id": 2 }}
{ "content":"Apple iPad" }
{ "index": { "_id": 3 }}
{ "content":"Apple employee like Apple Pie and Apple Juice" }

# 搜索 apple, _id=3会在第一条
POST news/_search
{
  "query": {
    "bool": {
      "must": {
        "match":{"content":"apple"}
      }
    }
  }
}

# 排除 包含pie的记录
POST news/_search
{
  "query": {
    "bool": {
      "must": {
        "match":{"content":"apple"}
      },
      "must_not": {
        "match":{"content":"pie"}
      }
    }
  }
}

# 通过boosting 将包含pie的权重下降，_id=3会在最后一条
POST news/_search
{
  "query": {
    "boosting": {
      "positive": {
        "match": {
          "content": "apple"
        }
      },
      "negative": {
        "match": {
          "content": "pie"
        }
      },
      "negative_boost": 0.5
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="最佳字段查询（Dis-Max-Query）"><a href="#最佳字段查询（Dis-Max-Query）" class="headerlink" title="最佳字段查询（Dis Max Query）"></a>最佳字段查询（Dis Max Query）</h2><p>只取分数最高的条件进行排序</p>
<pre class="line-numbers language-none"><code class="language-none"># 写入数据
POST /arvintest/_bulk
{ "index": { "_id": 1 }}
{ "title":"今天是一个悲伤而又欢快的有纪念意义的节日","content":"每年都都好多的有意义，有纪念价值的节日" }
{ "index": { "_id": 2 }}
{ "title":"有一点点悲伤的日子","content":"今天是纪念屈原的节日" }



# 将两个查询条件得分相加进行排序
GET arvintest/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "content": "纪念屈原的节日"
          }
        },
        {
          "match": {
            "title": "纪念屈原的节日"
          }
        }
      ]
    }
  }
}


# 根据其中得分最高的条件进行排序
GET arvintest/_search
{
  "query": {
    "dis_max": {
      "queries": [
        {
          "match": {
            "content": "纪念屈原的节日"
          }
        },
        {
          "match": {
            "title": "纪念屈原的节日"
          }
        }
        ]
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="九、聚合分析"><a href="#九、聚合分析" class="headerlink" title="九、聚合分析"></a>九、聚合分析</h2><h1 id="简介-8"><a href="#简介-8" class="headerlink" title="简介"></a>简介</h1><p>ES聚合分析 类似与对关系型数据的数据进行分组，排序，求和等操作</p>
<hr>
<h2 id="聚合与搜索"><a href="#聚合与搜索" class="headerlink" title="聚合与搜索"></a>聚合与搜索</h2><p>首先要弄清楚两个概念，聚合与搜索</p>
<ul>
<li><strong>搜索</strong>即从一个索引下按照特定的字段或关键词搜索出符合用户预期的一个或者一堆cocument，然后根据文档的相关度得分，在返回的结果集里并根据得分对这些文档进行一定的排序展示</li>
<li><strong>聚合</strong> 即对文档中的某个或某几个字段进行数据的分组并做一些指标数据的统计分析，比如要计算一批文档中某个业务字段的总数，平均数，最大最小值等操作</li>
</ul>
<h2 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h2><ul>
<li>Buckets(桶/集合):满足特定条件的文档的集合(类似group by)</li>
<li>Metrics(指标):对桶内的文档进行统计计算(例如最小值,求和,最大值等)</li>
</ul>
<p>写法</p>
<pre class="line-numbers language-none"><code class="language-none">GET es_order/_search
{
  "size": 0,
  "aggs": {
    "max_agg": {
      "max": {&lt;!--指标关键词--&gt;
        "field": "score"&lt;!--按照某个字段进行聚合--&gt;
      }
    }
  }
}

聚合查询中，size可以设置为0，表示不返回ES中的文档，只返回ES聚合之后的数据，提高查询速度，<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>*<strong>Metrics 指标*</strong></p>
<ul>
<li>1.AVG</li>
<li>2 Cardinality 值去重计数</li>
<li>3 Stats 统计 count max min avg sum 5个值</li>
<li>4 Extended Stats</li>
<li>5 Percentiles 占比百分位对应的值统计</li>
<li>6 Percentile Ranks 统计值小于等于指定值的文档占比</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># max
GET es_order/_search
{
  "size": 0,
  "query": {       # 添加状态查询条件
    "range": {
      "status": {
        "gt": 0,
        "lt": 15
      }
    }
  },
  "aggs": {
    "maxPrice": {
      "max": {
        "field": "amount"
      }
    }
  }
}

# min
GET es_order/_search
{
  "size": 0,
  "aggs": {
    "minPrice": {
      "min": {
        "field": "amount"
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Bucket 集合</strong></p>
<ul>
<li>1Filter</li>
<li>2 Range</li>
<li>3 Missing</li>
<li>4 Terms</li>
<li>5 Date Range</li>
<li>6 Global Aggregation</li>
<li>7 Histogram</li>
<li>8 Date Histogram</li>
<li>9 IPv4 range</li>
<li>10 Return only aggregation results</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 分组
GET es_order/_search
{
  "size": 0,
  "query": {
    "range": {
      "status": {
        "gt": 0,
        "lt": 5
      }
    }
  },
  "aggs": {
    "typeGroup": {
      "terms": {
        "size": 100, 
        "field": "goods_type"
      }
    }
  }
}



key为聚合的桶的名称，doc_count就是聚合的数量，有一个比较重要的地方，就是在做聚合分析的时候，该字段的mapping需要设置为不可分词才行。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="pipeline-聚合"><a href="#pipeline-聚合" class="headerlink" title="pipeline 聚合"></a>pipeline 聚合</h2><p>主要有如下两种管道聚合方式：</p>
<ul>
<li><p>parent 结果内嵌到现有聚合分析结果之中</p>
<p>Derivative（求导）</p>
<p>Cumultive Sum（累计求和）</p>
<p>Moving Function（滑动窗口）</p>
</li>
<li><p>sibling 结果现有分析结果同级</p>
<p>Max，min，Avg&amp;Sum Bucket</p>
<p>Stats ， Extened Status Bucket</p>
<p>Percentiles Bucket</p>
</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none"># 平均工资最低的工作类型
POST employees/_search
{
"size": 0,
"aggs": {
  "jobs": {
    "terms": {
      "field": "job.keyword",
      "size": 10
    },
    "aggs": {
      "avg_salary": {
        "avg": {
          "field": "salary"
        }
      }
    }
  },
  "min_salary_by_job": {
    "min_bucket": {
      "buckets_path": "jobs&gt;avg_salary"
    }
  }
}
}
# 平均工资最高的工作类型
POST employees/_search
{
"size": 0,
"aggs": {
  "jobs": {
    "terms": {
      "field": "job.keyword",
      "size": 10
    },
    "aggs": {
      "avg_salary": {
        "avg": {
          "field": "salary"
        }
      }
    }
  },
  "max_salary_by_job":{
    "max_bucket": {
      "buckets_path": "jobs&gt;avg_salary"
    }
  }
}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="聚合作用范围"><a href="#聚合作用范围" class="headerlink" title="聚合作用范围"></a>聚合作用范围</h2><ul>
<li>1、query和filter，是先选定数据范围，在聚合桶；</li>
<li>2、post_filter对聚合桶没影响，桶是全部返回，只对查询结果进行过滤返回</li>
<li>3、global的作用是覆盖掉query的查询作用</li>
</ul>
<h2 id="课件demo代码"><a href="#课件demo代码" class="headerlink" title="课件demo代码"></a>课件demo代码</h2><pre class="line-numbers language-none"><code class="language-none">PUT /employees/
{
  "mappings" : {
      "properties" : {
        "age" : {
          "type" : "integer"
        },
        "gender" : {
          "type" : "keyword"
        },
        "job" : {
          "type" : "text",
          "fields" : {
            "keyword" : {
              "type" : "keyword",
              "ignore_above" : 50
            }
          }
        },
        "name" : {
          "type" : "keyword"
        },
        "salary" : {
          "type" : "integer"
        }
      }
    }
}

PUT /employees/_bulk
{ "index" : {  "_id" : "1" } }
{ "name" : "Emma","age":32,"job":"Product Manager","gender":"female","salary":35000 }
{ "index" : {  "_id" : "2" } }
{ "name" : "Underwood","age":41,"job":"Dev Manager","gender":"male","salary": 50000}
{ "index" : {  "_id" : "3" } }
{ "name" : "Tran","age":25,"job":"Web Designer","gender":"male","salary":18000 }
{ "index" : {  "_id" : "4" } }
{ "name" : "Rivera","age":26,"job":"Web Designer","gender":"female","salary": 22000}
{ "index" : {  "_id" : "5" } }
{ "name" : "Rose","age":25,"job":"QA","gender":"female","salary":18000 }
{ "index" : {  "_id" : "6" } }
{ "name" : "Lucy","age":31,"job":"QA","gender":"female","salary": 25000}
{ "index" : {  "_id" : "7" } }
{ "name" : "Byrd","age":27,"job":"QA","gender":"male","salary":20000 }
{ "index" : {  "_id" : "8" } }
{ "name" : "Foster","age":27,"job":"Java Programmer","gender":"male","salary": 20000}
{ "index" : {  "_id" : "9" } }
{ "name" : "Gregory","age":32,"job":"Java Programmer","gender":"male","salary":22000 }
{ "index" : {  "_id" : "10" } }
{ "name" : "Bryant","age":20,"job":"Java Programmer","gender":"male","salary": 9000}
{ "index" : {  "_id" : "11" } }
{ "name" : "Jenny","age":36,"job":"Java Programmer","gender":"female","salary":38000 }
{ "index" : {  "_id" : "12" } }
{ "name" : "Mcdonald","age":31,"job":"Java Programmer","gender":"male","salary": 32000}
{ "index" : {  "_id" : "13" } }
{ "name" : "Jonthna","age":30,"job":"Java Programmer","gender":"female","salary":30000 }
{ "index" : {  "_id" : "14" } }
{ "name" : "Marshall","age":32,"job":"Javascript Programmer","gender":"male","salary": 25000}
{ "index" : {  "_id" : "15" } }
{ "name" : "King","age":33,"job":"Java Programmer","gender":"male","salary":28000 }
{ "index" : {  "_id" : "16" } }
{ "name" : "Mccarthy","age":21,"job":"Javascript Programmer","gender":"male","salary": 16000}
{ "index" : {  "_id" : "17" } }
{ "name" : "Goodwin","age":25,"job":"Javascript Programmer","gender":"male","salary": 16000}
{ "index" : {  "_id" : "18" } }
{ "name" : "Catherine","age":29,"job":"Javascript Programmer","gender":"female","salary": 20000}
{ "index" : {  "_id" : "19" } }
{ "name" : "Boone","age":30,"job":"DBA","gender":"male","salary": 30000}
{ "index" : {  "_id" : "20" } }
{ "name" : "Kathy","age":29,"job":"DBA","gender":"female","salary": 20000}

GET employees/_search
{
  "query": {
    "match_all": {}
  }
}


# 单独求最小值
GET employees/_search
{
  "size":0, 
  "aggs": {
    "maxMoney": {
      "min": {
        "field": "salary"
      }
    }
  }
}

# 最大值，最小值，平均值
GET employees/_search
{
  "size": 0,
  "aggs": {
    "status_info": {
      "stats": {
        "field": "salary"
      }
    }
  }
}

# 按job分桶
POST employees/_search
{
  "size": 0,
  "aggs": {
    "type": {
      "terms": {
        "field": "job.keyword",
        "size": 2
      }
    }
  }
}


# 指定size，不同工种中，年纪最大的3个员工的具体信息
GET employees/_search
{
  "size": 0,
  "aggs": {
    "jobs": {
      "terms": {
        "field": "job.keyword"
      },
      "aggs": {
        "old_employee": {
          "top_hits": {
            "size": 3
            , "sort": [
              {
                "age": {
                  "order": "desc"
                }
              }]
          }
        }
      }
    }
  }
}


#Salary Ranges 分桶，可以自己定义 key
GET employees/_search
{
  "size": 0,
  "aggs": {
    "salary_rang": {
      "range": {
        "field": "salary",
        "ranges": [
          {
            "to": 10000
          },
          {
            "from": 10000
            , "to": 20000
          },
          {
            "key": "&gt;20000", 
            "from": 20000
          }
        ]
      }
    }
  }
}



#Salary Histogram,工资0到10万，以 5000一个区间进行分桶
GET employees/_search
{
  "size": 0,
  "aggs": {
    "salary_histrogram": {
      "histogram": {
        "field": "salary",
        "interval": 5000,
        "extended_bounds": {  
          "min": 10000,
          "max": 50000
        }
      }
    }
  }
}



# 多次嵌套。根据工作类型分桶，然后按照性别分桶，计算工资的统计信息
GET employees/_search
{
  "size": 0,
  "aggs": {
    "em_jobs": {
      "terms": {
        "field": "job.keyword"
      },
      "aggs": {
        "em_sex": {
          "terms": {
            "field": "gender",
            "size": 10
          },
          "aggs": {
            "em_info": {
              "stats": {
                "field": "salary"
              }
            }
          }
        }
      }
    }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="按照日期分组"><a href="#按照日期分组" class="headerlink" title="按照日期分组"></a>按照日期分组</h1><pre class="line-numbers language-none"><code class="language-none"># 1.按照固定年月日进行分组
 POST fy_document_list/_search
{
    "size": 0, 
    "query":{
        "bool":{
            "must":[
                {
                    "term":{
                        "court.name":"重庆市江津区人民法院"
                    }
                },
                {
                  "range": {
                    "trial_date_time": {
                      "gt": "01/01/2000", 
                      "lt": "01/01/2022", 
                      "format": "dd/MM/yyyy||yyyy"
                    }
                  }
                }
            ]
        }
    },
    "aggs":{
        "trialDateGroup":{
            "date_histogram":{
                "field":"trial_date_time",
                "calendar_interval":"year"
            }
        }
    }
}
 
 
 
# 2.自定义分组区间
POST fy_document_list/_search
{
    "size": 0, 
    "query":{
        "bool":{
            "must":[
                {
                    "term":{
                        "court.name":"重庆市江津区人民法院"
                    }
                },
                {
                  "range": {
                    "trial_date_time": {
                      "gt": "2000/01/01", 
                      "lt": "2022/01/01", 
                      "format": "yyyy/dd/MM||yyyy"
                    }
                  }
                }
            ]
        }
    },
    "aggs":{
        "trialDateGroup":{
            "date_range": {
              "field": "trial_date_time",
              "format": "yyyy", 
              "ranges": [
                
                {
                  "from": "2012",
                  "to": "2013"
                },
                {
                  "from": "2013",
                  "to": "2014"
                },
                {
                  "from": "2014",
                  "to": "2015"
                }
              ]
            }
        }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="同时对多列进行分组统计-无法对doc-count进行排序"><a href="#同时对多列进行分组统计-无法对doc-count进行排序" class="headerlink" title="同时对多列进行分组统计(无法对doc_count进行排序)"></a>同时对多列进行分组统计(无法对doc_count进行排序)</h1><pre class="line-numbers language-none"><code class="language-none">POST fy_document_list/_search
{
  "size": 0, 
  "query":{
      "bool":{
          "must":[
              {
                  "term":{
                      "category_names":{
                          "value":"家庭婚姻"
                      }
                  }
              },
              {
                  "term":{
                      "court.province":{
                          "value":"湖南省"
                      }
                  }
              },
              {
                  "term":{
                      "court.city":{
                          "value":"长沙市"
                      }
                  }
              }
          ]
      }
  },
  "aggs":{
      "group_by_field":{
          "composite": {
            "size": 10, 
            "sources": [
              {
                "judge_key": {
                  "terms": {
                    "field": "judge.name"
                  }
                }
              },
              {
                "court_key":{
                  "terms": {
                    "field": "court.name"
                  }
                }
              }
            ]
          }
      }
  }
}

# 如果加载下一页，则在sources 字段后添加 上一个请求的after字段内容
"after": {
   "judge_key" : "001",
   "court_key" : "002"
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="对指定字段分组并求和-排序"><a href="#对指定字段分组并求和-排序" class="headerlink" title="对指定字段分组并求和 排序"></a>对指定字段分组并求和 排序</h1><pre class="line-numbers language-none"><code class="language-none">POST fy_lawyer_doc_item/_search
{
  "size": 0, 
  "query": {
    "term": {
      "court.city": {
        "value": "长沙市"
      }
    }
  },
  "aggs": {
      "lawyer_group": {
          "terms": {
              "field": "lawyer_id",
              "size": 10,
              "order": {
                  "score_sum": "desc"
              }
          },
          "aggs": {
              "score_sum": {
                  "sum": {
                      "field": "score"
                  }
              }
          }
      }
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="十、分页，遍历，并发处理"><a href="#十、分页，遍历，并发处理" class="headerlink" title="十、分页，遍历，并发处理"></a>十、分页，遍历，并发处理</h2><h1 id="简介-9"><a href="#简介-9" class="headerlink" title="简介"></a>简介</h1><p>具体实现案列</p>
<hr>
<h2 id="1-From-Size"><a href="#1-From-Size" class="headerlink" title="1.From, Size"></a>1.From, Size</h2><p>将查询的数据写入缓存， 当页数越深，占用内存越大会出现<strong>深度分页</strong>的问题</p>
<p>from，size:最大值为10000</p>
<pre class="line-numbers language-none"><code class="language-none">GET demo1/_search
{
  "from": 2, 
  "size": 2, 
  "query": {
    "match_all": {}
  }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-earch-after"><a href="#2-earch-after" class="headerlink" title="2.earch_after"></a>2.earch_after</h2><p>避免了深度分页的问题，可以实时获取下一页的数据</p>
<ul>
<li>不支持指定页数（from）</li>
<li>只能往下翻</li>
<li>需要指定sort,并且保证值是唯一的</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">## 第一次查询添加排序字段_id
POST demo1/_search
{
  "size": 1, 
  "query": {
    "match_all": {}
  },
  "sort": [
    {
      "age": "asc",
      "_id":"asc"
    }
  ]
  
}


## 后面的查询使用上一次查询结果当中sort的返回值
POST demo1/_search
{
  "size": 1, 
  "query": {
    "match_all": {}
  },
  "search_after":
    [
          11,
          "R5PTdXQBQ2jxSlVAT4RO"
        ]
  ,
  "sort": [
    {
      "age": "asc",
      "_id":"asc"
    }
  ]
  
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-Scroll-API"><a href="#3-Scroll-API" class="headerlink" title="3.Scroll API"></a>3.Scroll API</h2><ul>
<li>需要创建快照</li>
<li>有新的数据写入后，本次查询无法被实时搜索到</li>
<li>需要输入上一次的查询ID</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">## 创建快照（有效时间5分钟）
POST /demo1/_search?scroll=5m
{
    "size": 1,
    "query": {
        "match_all" : {
        }
    }
}


## 使用创建好的ID
POST /_search/scroll
{
    "scroll" : "1m",
    "scroll_id" : "FGluY2x1ZGVfY29udGV4dF91dWlkDXF1ZXJ5QW5kRmV0Y2gBFFVaUGFkWFFCUTJqeFNsVkE0SVIxAAAAAAAAeMQWeE1FUzFTN1RUcENHSDdNMDBUbWNJQQ=="
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-并发处理"><a href="#4-并发处理" class="headerlink" title="4. 并发处理"></a>4. 并发处理</h2><ul>
<li>ES 使用乐观锁（mysql 使用悲观锁，行锁）</li>
<li>使用<strong>if_seq_no ， if_primary_term</strong> 来进行控制</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">PUT products/_doc/1
{
  "title":"iphone",
  "count":100
}


GET products/_doc/1


PUT products/_doc/1?if_seq_no=1&amp;if_primary_term=1
{
  "title":"iphone",
  "count":100
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当同时有多个人操作同一个文档时 <strong>if_seq_no ， if_primary_term</strong> 被使用过后，会有报错提示。</p>
<h2 id="十一、Logstash使用"><a href="#十一、Logstash使用" class="headerlink" title="十一、Logstash使用"></a>十一、Logstash使用</h2><h1 id="简介-10"><a href="#简介-10" class="headerlink" title="简介"></a>简介</h1><p>Logstash 是一个实时数据收集引擎，可收集各类型数据并对其进行分析，过滤和归纳。按照自己条件分析过滤出符合数据导入到可视化界面。 同时它也是 Elastic 栈非常重要的一部分，但是它不仅仅为 Elasticsearch 所使用。它可以介绍广泛的各种数据源。Logstash 可以帮利用它自己的Filter帮我们对数据进行解析，丰富，转换等</p>
<hr>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><a target="_blank" rel="noopener" href="https://www.newbe.pro/Mirrors/Mirrors-Logstash/">下载链接</a></p>
<pre class="line-numbers language-none"><code class="language-none">wget url
tar xf /opt/logstash-5.6.1.tar.gz -C /usr/local
mv /usr/local/logstash-5.6.1 /usr/local/logstash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h1 id="配置组成"><a href="#配置组成" class="headerlink" title="配置组成"></a>配置组成</h1><p><a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns">1.Grok插件使用说明</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34021712/article/details/79746413">2.Grok使用案例</a></p>
<ul>
<li>input 数据输入</li>
<li>filter 数据筛选</li>
<li>output 数据输出</li>
</ul>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><ul>
<li>在logstash目录下创建配置文件 arvin.conf</li>
<li>bin/logstash -t -f arvin.conf 测试配置文件是否可用</li>
<li>bin/logstash -f arvin.conf 启动</li>
<li>nohup bin/logstash -f arvin.conf &amp; 挂起到后台运行</li>
</ul>
<h1 id="测试配置"><a href="#测试配置" class="headerlink" title="测试配置"></a>测试配置</h1><p><a target="_blank" rel="noopener" href="http://grokdebug.herokuapp.com/">线上测试grok测试</a></p>
<pre class="line-numbers language-none"><code class="language-none">input{
    beats{port=&gt;"5044"}
#       file{
#           path=&gt;"/root/test2.log"
#           start_position =&gt; "beginning"
#       }

}
filter{
        grok{
                match=&gt;{"message"=&gt;"\[(?:-|%{IP:ip})\] %{IP:transfer} %{WORD:method} %{URIPATH:action}(?:%{URIPARAM:para})? HTTP/%{NUMBER:httpversion} %{HTTPDATE:timestamp} (?:-|%{NUMBER:code}) (?:-|%{NUMBER:bytes})"}
        }   

        geoip{
                source=&gt;"ip"
                database=&gt;"/usr/local/logstash/GeoLite2-City_20200915/GeoLite2-City.mmdb"
        }   
}
output{
   elasticsearch {    
        user =&gt; elastic
        password =&gt; arvinhe
        hosts=&gt; "http://120.25.168.102:9200"
        index =&gt; "logstash-ls-nginx-%{+YYYY.MM.dd}"   
    }   
#   stdout{codec=&gt; rubydebug}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<ul>
<li>input详解</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">input{
#    beats{port=&gt;"5044"}   filebeat TCP 端口传输数据
        # 本地文件上传
        file{
            path=&gt;"/root/test2.log"
            start_position =&gt; "beginning"
        }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>filter 过滤器</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">filter{
        grok{
            match=&gt;{"message"=&gt;"\[(?:-|%{IP:ip})\] %{IP:transfer} %{WORD:method} %{URIPATH:action}(?:%{URIPARAM:para})? HTTP/%{NUMBER:httpversion} %{HTTPDATE:timestamp} (?:-|%{NUMBER:code}) (?:-|%{NUMBER:bytes})"}
        }

       geoip{
               source=&gt;"ip"
               database=&gt;"/usr/local/logstash/GeoLite2-City_20200915/GeoLite2-City.mmdb"
       }
}


\[(?:-|%{IP:ip})\] : 匹配[]中的IP(真实IP)
%{IP:transfer}: 转发内网IP
%{WORD:method}:请求方法名
%{URIPATH:action}(?:%{URIPARAM:para})? ：action方法 para参数
HTTP/%{NUMBER:httpversion}: http版本号
%{HTTPDATE:timestamp} :时间戳
(?:-|%{NUMBER:code}) :状态码
(?:-|%{NUMBER:bytes}):字节数<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>output 输出</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">output{
# 输出到elasticsearch
    elasticsearch {    
        user =&gt; elastic
        password =&gt; arvinhe
        hosts=&gt; "http://120.25.168.102:9200"
        index =&gt; "logstash-ls-nginx-%{+YYYY.MM.dd}"   
    }  
    #  控制面板输出
   stdout{codec=&gt; rubydebug}
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="十二、Filebeat-使用"><a href="#十二、Filebeat-使用" class="headerlink" title="十二、Filebeat 使用"></a>十二、Filebeat 使用</h2><h1 id="简介-11"><a href="#简介-11" class="headerlink" title="简介"></a>简介</h1><p>Filebeat用于收集和传送日志文件，它也是最常用的Beat。 Filebeat如此高效的事实之一就是它处理背压的方式-因此，如果Logstash繁忙，Filebeat会减慢其读取速率，并在减速结束后加快节奏。 Filebeat几乎可以安装在任何操作系统上，包括作为Docker容器安装，还随附用于特定平台（例如Apache，MySQL，Docker等）的内部模块，其中包含这些平台的默认配置和Kibana对象。</p>
<hr>
<h1 id="Beats是什么"><a href="#Beats是什么" class="headerlink" title="Beats是什么?"></a>Beats是什么?</h1><p>在讲解Filebeat之前，我需要先了解一下Beats是什么 。</p>
<p>Elastic Stack传统上由三个主要组件（Elasticsearch，Logstash和Kibana）组成，早已脱离了这种组合，现在也可以与名为“ Beats”的第四个元素结合使用–一个针对不同用例的日志运送者系列。 现在网上有一种说法叫做ELKB，这里的B就是指的beats.</p>
<p>Beats是轻量级（资源高效，无依赖性，小型）和开放源代码日志发送程序的集合，这些日志发送程序充当安装在基础结构中不同服务器上的代理，用于收集日志或指标（metrics）。这些可以是日志文件（Filebeat），网络数据（Packetbeat），服务器指标（Metricbeat）或Elastic和社区开发的越来越多的Beats可以收集的任何其他类型的数据。<br>收集后，数据将直接发送到Elasticsearch或Logstash中进行其他处理。Beats建立在名为libbeat的Go框架之上，该框架用于数据转发，这意味着社区一直在开发和贡献新的Beats。</p>
<p><strong>而Filebeat就是Beats其中的一种，收集数据的流程Filebeat-&gt;logstash-&gt;ES</strong></p>
<h1 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h1><p><a target="_blank" rel="noopener" href="https://www.newbe.pro/Mirrors/Mirrors-Filebeat/">下载链接</a></p>
<pre class="line-numbers language-none"><code class="language-none"># 下载
wget https://mirrors.huaweicloud.com/filebeat/7.8.0/filebeat-7.8.0-linux-x86_64.tar.gz

# 解压
tar -zxvf filebeat-7.8.0-linux-x86_64.tar.gz

# 移动
mv filebeat-7.8.0-linux-x86_64 /usr/local/filebeat-7.8.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><ul>
<li><p>修改yml文件</p>
<ul>
<li>paths: log日志地址</li>
<li>enabled：true 启动这个节点</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">filebeat.inputs:
    - type: log
    enabled: true
    paths:
        - /www/wwwlogs/addition.lvshiguan.com.log  # 日志文件的绝对路径<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>发送到logstash</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">output.logstash:
    hosts: ["120.25.168.102:5044"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>启动</p>
<ul>
<li>./filebeat -e -c filebeat.yml -d “publish”</li>
</ul>
</li>
</ul>
<h1 id="挂起到后台执行"><a href="#挂起到后台执行" class="headerlink" title="挂起到后台执行"></a>挂起到后台执行</h1><ul>
<li>nohup ./filebeat -e -c filebeat.yml &gt; filebeat.log &amp;</li>
<li>exit 退出用户<ul>
<li>在当shell中执行nohup成功后，还需要按终端上键盘任意键退回到shell输入命令窗口，然后通过在shell中输入exit来退出终端；如果在nohup执行成功后直接点关闭程序按钮关闭终端的话，这时候会断掉该命令所对应的session，导致nohup对应的进程被通知需要一起shutdown，起不到关掉终端后调用程序继续后台运行的作用。</li>
</ul>
</li>
<li>查看进程 ps -ef|grep filebeat</li>
</ul>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Es/">
                                    <span class="chip bg-color">Es</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="google,qq,wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '19oiG8bs08KUJVam2UnK0yuh-gzGzoHsz',
        appKey: '9ksjQRS4Fm9xmxDE3L2kFHbx',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '欢迎在此留言'
    });
</script>

<!--酷Q推送-->


    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/06/17/elasticsearch-ji-qun-bu-shu/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.png" class="responsive-img" alt="Elasticsearch集群部署">
                        
                        <span class="card-title">Elasticsearch集群部署</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Elasticsearch
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-06-17
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Elasticsearch/" class="post-category">
                                    Elasticsearch
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Es/">
                        <span class="chip bg-color">Es</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/06/17/dsl-yu-fa-shi-yong/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.png" class="responsive-img" alt="DSL语法使用">
                        
                        <span class="card-title">DSL语法使用</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Elasticsearch
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-06-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Elasticsearch/" class="post-category">
                                    Elasticsearch
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Es/">
                        <span class="chip bg-color">Es</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            &nbsp;&copy;
            
                <span id="year">2021</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">L</a>
            &nbsp;岛&nbsp;<a href="https://github.com/positivefunction" target="_blank">Github</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">74.6k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                &nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                &nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "6";
                    var startDate = "5";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/positivefunction" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1647924460" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1647924460" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>


</div>
    </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
